<!DOCTYPE html>
<!--
  Copyright 2010 Google Inc.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

  Original slides: Marcin Wichary (mwichary@google.com)
  Modifications: Ernest Delgado (ernestd@google.com)
                 Alex Russell (slightlyoff@chromium.org)

  landslide modifications: Adam Zapletal (adamzap@gmail.com)
                           Nicolas Perriault (nperriault@gmail.com)
-->
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Lecture 10a: <a href="https://github.com/twitter/algebird">Algebird</a> in Spark</title>
    <!-- Styles -->
    
    <link rel="stylesheet" media="print" href="theme/css/print.css">
    <link rel="stylesheet" media="screen, projection" href="theme/css/screen.css">
    
    
    <!-- /Styles -->
    <!-- Javascripts -->
    
    <script type="text/javascript" src="theme/js/slides.js"></script>
    
    
    <!-- /Javascripts -->
</head>
<body style="!important;">
  <div id="blank"></div>
  <div class="presentation">
    <div id="current_presenter_notes">
      <div id="presenter_note"></div>
    </div>
    <div class="slides">
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Lecture 10a: <a href="https://github.com/twitter/algebird">Algebird</a> in Spark</h1></header>
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              1/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1><a href="https://github.com/twitter/algebird">Algebird</a></h1></header>
            
            
            <section><p>"Abstract algebra for Scala. This code is targeted at building aggregation systems (via Scalding or Storm)."</p>
<p><br />
<br /></p>
<ul>
<li>Algebraic structures like semigroup and monoid, as Scala <code>trait</code>s</li>
<li>Many useful monoids, to fit common aggregation patterns</li>
<li>However, dependent in production on:<ul>
<li>Spark</li>
<li><a href="https://github.com/twitter/scalding">Scalding</a> (batch jobs)</li>
<li><a href="https://en.wikipedia.org/wiki/Storm_(event_processor)">Storm</a> (streaming)</li>
<li>or <a href="https://github.com/twitter/summingbird">Summingbird</a> ( batch or real time )</li>
</ul>
</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              2/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Monoid review</h1></header>
            
            
            <section><p>"In abstract algebra, a branch of mathematics, a monoid is an algebraic structure with </p>
<p>(1) a single associative binary operation </p>
<p>and </p>
<p>(2) an identity element."</p>
<p><br /></p>
<p>Commutativity of the binary operation is useful, but not required.</p>
<p><br />
<br /></p>
<p><a href="https://en.wikipedia.org/wiki/Monoid">https://en.wikipedia.org/wiki/Monoid</a></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              3/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            
            <section><p>Associativity allows some parallelism.</p>
<p>We want aggregation <code>a + b + c + d</code></p>
<pre><code>a + b + c + d == 
a + (b + (c + d)) ==
(a + b) + (c + d)
</code></pre>
<p>This "splitting" pattern of parallelism is exemplified by exercise 10.7: <code>foldMapV</code></p>
<p><br />
<br />
<br />
<br /></p>
<p>Later, commutativity</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              4/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Count-Min Sketch</h1></header>
            
            
            <section><p>"the Sketch ... uses
summary based techniques for delivering approximation queries, gets around the typical problems that
sampling techniques have and are highly parallelizable in practice."</p>
<ul>
<li><a href="http://debasishg.blogspot.com/2014/01/count-min-sketch-data-structure-for.html">Count-Min Sketch - A Data Structure for Stream Mining Applications</a></li>
</ul>
<p><br />
<br />
<a href="https://en.wikipedia.org/wiki/Count%E2%80%93min_sketch">Wiki</a></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              5/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            
            <section><p>Count-Min Sketches can be combined</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CMS</span><span class="o">[</span><span class="kt">K</span><span class="o">]</span> <span class="o">{</span> 
  <span class="o">...</span>
  <span class="c1">// Returns a new sketch that is the combination </span>
  <span class="c1">// of this sketch and the other sketch.</span>
  <span class="k">def</span> <span class="o">++(</span><span class="n">other</span><span class="k">:</span> <span class="kt">CMS</span><span class="o">[</span><span class="kt">K</span><span class="o">])</span><span class="k">:</span> <span class="kt">CMS</span><span class="o">[</span><span class="kt">K</span><span class="o">]</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>

<p><br />
<br />
<br />
<br /></p>
<p><a href="http://twitter.github.io/algebird/index.html#com.twitter.algebird.CMS">CMS</a></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              6/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            <header><h1><a href="http://twitter.github.io/algebird/#com.twitter.algebird.CMSMonoid">Count-min Sketch Monoid</a></h1></header>
            
            
            <section><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CMSMonoid</span><span class="o">[</span><span class="kt">K</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">Monoid</span><span class="o">[</span><span class="kt">CMS</span><span class="o">[</span><span class="kt">K</span><span class="o">]]</span>
</pre></div>

<p><a href="http://twitter.github.io/algebird/#com.twitter.algebird.CMS">Count-Min Sketches</a> under combination form a Monoid.  The identity element is an empty sketch.  It has a generic for the type being counted.</p>
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">cmsMonoid</span><span class="k">:</span> <span class="kt">CMSMonoid</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">eps</span> <span class="k">=</span> <span class="mf">0.001</span>
  <span class="k">val</span> <span class="n">delta</span> <span class="k">=</span> <span class="mi">1</span><span class="n">E</span><span class="o">-</span><span class="mi">10</span>
  <span class="k">val</span> <span class="n">seed</span> <span class="k">=</span> <span class="mi">1</span>
  <span class="nc">CMS</span><span class="o">.</span><span class="n">monoid</span><span class="o">[</span><span class="kt">Int</span><span class="o">](</span><span class="n">eps</span><span class="o">,</span> <span class="n">delta</span><span class="o">,</span> <span class="n">seed</span><span class="o">)</span>
<span class="o">}</span>
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              7/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            
            <section><div class="highlight"><pre><span></span><span class="c1">// def create(item: K): CMS[K] </span>
<span class="c1">// Creates a sketch out of a single item.</span>
<span class="k">val</span> <span class="n">sketch1</span><span class="k">:</span> <span class="kt">CMS</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="n">cmsMonoid</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span>
<span class="k">val</span> <span class="n">sketch2</span><span class="k">:</span> <span class="kt">CMS</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="n">cmsMonoid</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span>
<span class="k">val</span> <span class="n">sketch3</span><span class="k">:</span> <span class="kt">CMS</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="n">cmsMonoid</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="mi">6</span><span class="o">)</span>

<span class="k">val</span> <span class="n">aggregatedSketch</span><span class="k">:</span> <span class="kt">CMS</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> 
  <span class="n">sketch1</span> <span class="o">++</span> <span class="n">sketch2</span> <span class="o">++</span> <span class="n">sketch3</span>
</pre></div>

<p><br />
<br />
<br /></p>
<p>in <code>slideCode.lecture10a.CountMinSketchUsage</code>
and <code>slideCode.lecture10a.SketchExample</code></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              8/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            
            <section><pre><code>frequency of 4 in sketch1 = 
  Approximate(1,1,1,1.0)
frequency of 6 in sketch1 = 
  Approximate(0,0,0,1.0)

frequency of 4 in aggregatedSketch = 
  Approximate(2,2,2,0.9999999999)
frequency of 6 in aggregatedSketch = 
  Approximate(1,1,1,0.9999999999)
</code></pre>
<p><br />
<br />
<br />
<br />
<br />
<br /></p>
<p>in <code>slideCode.lecture10a.SketchExample</code></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              9/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            <header><h1>Algebird example</h1></header>
            
            
            <section><p>Counting approximate number of Tweets per user;</p>
<p>an example of a Key-Value aggregation</p>
<div class="highlight"><pre><span></span><span class="k">case</span> <span class="k">class</span> <span class="nc">Tweet</span><span class="o">(</span><span class="n">userId</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">message</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> 
                 <span class="n">time</span><span class="k">:</span> <span class="kt">DateTime</span><span class="o">)</span>

<span class="k">def</span> <span class="n">generateTweets</span><span class="o">(</span><span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Tweet</span><span class="o">]</span> <span class="k">=</span> <span class="o">...</span>
</pre></div>

<p><br />
<br />
<br />
<br /></p>
<p>in <code>slideCode.lecture10a.Tweets</code></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              10/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            
            <section><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">tweets</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Tweet</span><span class="o">]</span> <span class="k">=</span> <span class="n">generateTweets</span><span class="o">(</span><span class="mi">32</span><span class="o">)</span>

<span class="k">val</span> <span class="n">userIds</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> 
  <span class="n">tweets</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="n">tweet</span> <span class="k">=&gt;</span> <span class="n">tweet</span><span class="o">.</span><span class="n">userId</span> <span class="o">}</span>

<span class="c1">// cmsMonoid.create(data: Seq[K]): CMS[K]`</span>
<span class="c1">// Creates a sketch out of multiple items.</span>
<span class="k">val</span> <span class="n">sketch</span><span class="k">:</span> <span class="kt">CMS</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="n">cmsMonoid</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="n">userIds</span><span class="o">)</span>
</pre></div>

<p>This version of <code>create</code> folds with the Monoid.  It hides a lot under the hood.</p>
<p>It useful for one-off experimentation, but not production use of the CMSMonoid.</p>
<p><br />
<br />
<br /></p>
<p>in <code>slideCode.lecture10a.CountMinSketchUsage</code> and <code>slideCode.lecture10a.CountMinSketchUsageExample</code></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              11/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            
            <section><p>Values in the Sketch</p>
<pre><code>Count Min Sketch counts
user 0 Approximate(1,1,1,0.9999999999)
user 1 Approximate(3,3,3,0.9999999999)
user 2 Approximate(1,1,1,0.9999999999)
user 3 Approximate(2,2,2,0.9999999999)
user 4 Approximate(0,0,0,1.0)
user 5 Approximate(1,1,1,0.9999999999)
...
</code></pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              12/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            
            <section><pre><code>exact counts
user 0 exact count Some(1)
user 1 exact count Some(3)
user 2 exact count Some(1)
user 3 exact count Some(2)
user 4 exact count None
user 5 exact count Some(1)
</code></pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              13/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            
            <section><p>Commutativity improves parallelism further and reduces storage requirements.</p>
<p>Reducing storage requirements is the essence of "real-time" streaming analysis.</p>
<p>We want aggregation <code>a + b + c + d</code></p>
<p>Imagine a stream where <code>c</code> and <code>d</code> arrive first, <code>b</code> second and <code>a</code> third.</p>
<pre><code>c + d = e

(e + b) + a ==
c + d + b + a
</code></pre>
<p><br />
<br />
<br />
<br /></p>
<p><a href="https://www.parleys.com/tutorial/algebird-algebra-efficient-big-data-processing">Sources  at 7:40 and 12:45</a></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              14/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            
            <section><p><img alt="" src="images/lecture10a/grouplike_structures.png" /></p>
<p><a href="https://en.wikipedia.org/wiki/Outline_of_algebraic_structures">Source: Outline of algebraic structures</a></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              15/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            
            <section><p>There is no data type in Algebird that connotates commutativity.
<a href="https://github.com/twitter/algebird/issues/128">Discussion</a></p>
<p>There is only run-time checking</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="n">isCommutativeEq</span><span class="o">[</span><span class="kt">T:</span> <span class="kt">Semigroup</span><span class="o">]</span>
  <span class="o">(</span><span class="n">eqfn</span><span class="k">:</span> <span class="o">(</span><span class="kt">T</span><span class="o">,</span> <span class="kt">T</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Boolean</span><span class="o">)</span> <span class="k">=</span> 
  <span class=" -Symbol">&#39;isCommutativeEq</span> <span class="o">|:</span> <span class="n">forAll</span> <span class="o">{</span> <span class="o">(</span><span class="n">a</span><span class="k">:</span> <span class="kt">T</span><span class="o">,</span> <span class="n">b</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="k">val</span> <span class="n">semi</span> <span class="k">=</span> <span class="n">implicitly</span><span class="o">[</span><span class="kt">Semigroup</span><span class="o">[</span><span class="kt">T</span><span class="o">]]</span>
    <span class="n">eqfn</span><span class="o">(</span><span class="n">semi</span><span class="o">.</span><span class="n">plus</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">),</span> <span class="n">semi</span><span class="o">.</span><span class="n">plus</span><span class="o">(</span><span class="n">b</span><span class="o">,</span> <span class="n">a</span><span class="o">))</span>
  <span class="o">}</span>
</pre></div>

<p>Some of this method should look familiar from our monoid laws exercise in lab 10</p>
<p><br />
<br />
<br />
<br />
<br />
<br /></p>
<p>in <code>package com.twitter.algebird.BaseProperties</code></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              16/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            <header><h1>Max Monoid in Spark</h1></header>
            
            
            <section><p>Calculate (exact) maximum score of any game in <code>basketball_scores.csv</code></p>
<p>read CSV</p>
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">df</span><span class="k">:</span> <span class="kt">DataFrame</span> <span class="o">=</span> <span class="o">...</span>
</pre></div>

<p>CSV</p>
<pre><code>...,TeamName,...,ScoreOff,...
...,Abilene Christian,...,57,...
...,Abilene Christian,...,100,...
...,Abilene Christian,...,72,...
...
...,Alabama St.,...,73,...
...
</code></pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              17/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            
            <section><p>Wrap each score in a <code>Max</code> object</p>
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">maxScores</span><span class="k">:</span> <span class="kt">RDD</span><span class="o">[</span><span class="kt">Max</span><span class="o">[</span><span class="kt">Int</span><span class="o">]]</span> <span class="k">=</span> 
  <span class="n">df</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="o">(</span><span class="n">r</span><span class="k">:</span> <span class="kt">Row</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Max</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="n">getInt</span><span class="o">(</span><span class="mi">5</span><span class="o">))</span> <span class="o">}</span>
<span class="c1">//        5th column; 0-indexed     ^</span>
</pre></div>

<p>Reduce the <code>Max</code> objects to a single <code>Max</code> object</p>
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">maxScore</span><span class="k">:</span> <span class="kt">Max</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> 
  <span class="n">maxScores</span><span class="o">.</span><span class="n">reduce</span> <span class="o">{</span> <span class="o">(</span><span class="n">m1</span><span class="o">,</span> <span class="n">m2</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">m1</span><span class="o">.+(</span><span class="n">m2</span><span class="o">)</span> <span class="o">}</span>
</pre></div>

<p>in <code>spark.lecture10a.MaxScoreExample</code>
<br />
<br /></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              18/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            
            <section><div class="highlight"><pre><span></span><span class="o">(</span><span class="n">m1</span><span class="o">,</span> <span class="n">m2</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">m1</span><span class="o">.+(</span><span class="n">m2</span><span class="o">)</span>
</pre></div>

<p><br />
<br /></p>
<p><a href="http://twitter.github.io/algebird/#com.twitter.algebird.PlusOp">Infix notation for <code>Max</code> is buried in Algebird library</a>.  There is not a clear connection between infix <code>+</code> and the <code>Max</code> class.  Contrast this with HyperLogLog, later.</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              19/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            <header><h1><a href="http://spark.apache.org/docs/latest/api/scala/index.html#org.apache.spark.rdd.PairRDDFunctions">Pair RDD</a></h1></header>
            
            
            <section><p>Calculate max score by team</p>
<p>Want to apply this method:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="n">reduceByKey</span><span class="o">(</span><span class="n">func</span><span class="k">:</span> <span class="o">(</span><span class="kt">V</span><span class="o">,</span> <span class="kt">V</span><span class="o">)</span> <span class="k">⇒</span> <span class="n">V</span><span class="o">)</span><span class="k">:</span> <span class="kt">RDD</span><span class="o">[(</span><span class="kt">K</span>, <span class="kt">V</span><span class="o">)]</span>
</pre></div>

<p>Key by team name</p>
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">keyedScores</span><span class="k">:</span> <span class="kt">RDD</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Max</span><span class="o">[</span><span class="kt">Int</span><span class="o">])]</span> <span class="k">=</span> 
  <span class="n">keyedRDD</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="o">(</span><span class="n">tup</span><span class="k">:</span> <span class="o">(</span><span class="kt">String</span><span class="o">,</span> <span class="kt">Row</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">teamName</span> <span class="k">=</span> <span class="n">tup</span><span class="o">.</span><span class="n">_1</span>
    <span class="k">val</span> <span class="n">row</span> <span class="k">=</span> <span class="n">tup</span><span class="o">.</span><span class="n">_2</span>
    <span class="k">val</span> <span class="n">score</span> <span class="k">=</span> <span class="n">row</span><span class="o">.</span><span class="n">getInt</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span>
    <span class="o">(</span><span class="n">teamName</span><span class="o">,</span> <span class="nc">Max</span><span class="o">(</span><span class="n">score</span><span class="o">))</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<p>in <code>spark.lecture10a.MaxScoreExample</code>
<br /></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              20/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            
            <section><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">maxScoreByTeam</span><span class="k">:</span> <span class="kt">RDD</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Max</span><span class="o">[</span><span class="kt">Int</span><span class="o">])]</span> <span class="k">=</span> 
  <span class="n">keyedScores</span><span class="o">.</span><span class="n">reduceByKey</span> <span class="o">{</span> <span class="o">(</span><span class="n">s1</span><span class="o">,</span> <span class="n">s2</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">s1</span><span class="o">+</span><span class="n">s2</span> <span class="o">}</span>

<span class="n">maxScoreByTeam</span><span class="o">.</span><span class="n">foreach</span> <span class="o">{</span> 
  <span class="k">case</span> <span class="o">(</span><span class="n">teamName</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">maxScore</span><span class="k">:</span> <span class="kt">Max</span><span class="o">[</span><span class="kt">Int</span><span class="o">])</span> <span class="k">=&gt;</span> 
  <span class="n">println</span><span class="o">(</span><span class="s">s&quot;Team </span><span class="si">$teamName</span><span class="s">  max score </span><span class="si">$maxScore</span><span class="s">&quot;</span><span class="o">)}</span>
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              21/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            
            <section><p>Output</p>
<pre><code>Team Massachusetts  max score Max(108)
Team Hampton  max score Max(98)
Team Winthrop  max score Max(102)
Team Alabama St.  max score Max(86)
...
</code></pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              22/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            <header><h1>Count-min sketch in Spark</h1></header>
            
            
            <section><p>Estimate the number of games each team has played </p>
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">df</span><span class="k">:</span> <span class="kt">DataFrame</span> <span class="o">=</span> <span class="o">...</span>

<span class="k">val</span> <span class="n">cmsMonoid</span><span class="k">:</span> <span class="kt">CMSMonoid</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">eps</span> <span class="k">=</span> <span class="mf">0.001</span>
  <span class="k">val</span> <span class="n">delta</span> <span class="k">=</span> <span class="mi">1</span><span class="n">E</span><span class="o">-</span><span class="mi">10</span>
  <span class="k">val</span> <span class="n">seed</span> <span class="k">=</span> <span class="mi">1</span>
  <span class="nc">CMS</span><span class="o">.</span><span class="n">monoid</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="n">eps</span><span class="o">,</span> <span class="n">delta</span><span class="o">,</span> <span class="n">seed</span><span class="o">)</span>
<span class="o">}</span>
</pre></div>

<p><br />
<br /></p>
<p>in <code>spark.lecture10a.CountMinSketchExample</code></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              23/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            
            <section><p>Create <a href="http://twitter.github.io/algebird/#com.twitter.algebird.CMS">sketch</a> of team name of each row</p>
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">teamSketches</span><span class="k">:</span> <span class="kt">RDD</span><span class="o">[</span><span class="kt">CMS</span><span class="o">[</span><span class="kt">String</span><span class="o">]]</span> <span class="k">=</span> 
  <span class="n">df</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="o">(</span><span class="n">row</span><span class="k">:</span> <span class="kt">Row</span><span class="o">)</span> <span class="k">=&gt;</span> 
    <span class="n">cmsMonoid</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="n">getString</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span> <span class="o">}</span>
</pre></div>

<p>Reduce sketches to single sketch</p>
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">counts</span><span class="k">:</span> <span class="kt">CMS</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> 
  <span class="n">teamSketches</span><span class="o">.</span><span class="n">reduce</span> <span class="o">{</span> <span class="o">(</span><span class="n">s1</span><span class="o">,</span> <span class="n">s2</span><span class="o">)</span> <span class="k">=&gt;</span> 
    <span class="n">cmsMonoid</span><span class="o">.</span><span class="n">plus</span><span class="o">(</span><span class="n">s1</span><span class="o">,</span> <span class="n">s2</span><span class="o">)</span> <span class="o">}</span>
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              24/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            
            <section><p>Find distinct team names</p>
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">teams</span><span class="k">:</span> <span class="kt">RDD</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> 
  <span class="n">df</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="o">(</span><span class="n">row</span><span class="k">:</span> <span class="kt">Row</span><span class="o">)</span> <span class="k">=&gt;</span> 
    <span class="n">row</span><span class="o">.</span><span class="n">getString</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">}.</span><span class="n">distinct</span><span class="o">()</span>
</pre></div>

<p>Extract <em>frequency</em> of each key in aggregate sketch</p>
<div class="highlight"><pre><span></span><span class="n">teams</span><span class="o">.</span><span class="n">foreach</span> <span class="o">{</span> <span class="n">teamName</span> <span class="k">=&gt;</span>
  <span class="k">val</span> <span class="n">freqEstimate</span> <span class="k">=</span> 
    <span class="n">counts</span><span class="o">.</span><span class="n">frequency</span><span class="o">(</span><span class="n">teamName</span><span class="o">).</span><span class="n">estimate</span>
  <span class="n">println</span><span class="o">(</span><span class="s">s&quot;... </span><span class="si">$teamName</span><span class="s"> ... </span><span class="si">$freqEstimate</span><span class="s"> ...&quot;</span><span class="o">)</span>
<span class="o">}</span>
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              25/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            
            <section><pre><code>Team Tennessee Tech played an estimated 28 games
Team Western Mich. played an estimated 30 games
Team Savannah St. played an estimated 29 games
Team Campbell played an estimated 27 games
Team Memphis played an estimated 34 games
Team Colorado St. played an estimated 32 games
Team Bowling Green played an estimated 32 games
Team Loyola Maryland played an estimated 30 games
Team Hampton played an estimated 30 games
Team Massachusetts played an estimated 32 games
Team Winthrop played an estimated 29 games
...
</code></pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              26/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            <header><h1>HyperLogLog in Spark</h1></header>
            
            
            <section><p>Estimate the number of unique rows</p>
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">df</span><span class="k">:</span> <span class="kt">DataFrame</span> <span class="o">=</span> <span class="o">...</span>

<span class="k">val</span> <span class="n">hll</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">HyperLogLogMonoid</span><span class="o">(</span><span class="mi">12</span><span class="o">)</span>
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              27/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            
            <section><p>Hash and sketch each <a href="http://spark.apache.org/docs/latest/api/scala/index.html#org.apache.spark.sql.Row"><code>Row</code></a></p>
<p><code>r.hashCode</code> incorporates every value in the row.</p>
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">rowHashes</span><span class="k">:</span> <span class="kt">RDD</span><span class="o">[</span><span class="kt">HLL</span><span class="o">]</span> <span class="k">=</span> 
  <span class="n">df</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="o">(</span><span class="n">r</span><span class="k">:</span> <span class="kt">Row</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">hll</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="n">hashCode</span><span class="o">)</span> <span class="o">}</span>
</pre></div>

<p><br />
<br /></p>
<p>Combine sketches into single sketch</p>
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">uniqueRowCount</span><span class="k">:</span> <span class="kt">HLL</span> <span class="o">=</span> 
  <span class="n">rowHashes</span><span class="o">.</span><span class="n">reduce</span><span class="o">(</span> <span class="o">(</span><span class="n">hll1</span><span class="o">,</span> <span class="n">hll2</span><span class="o">)</span> <span class="k">=&gt;</span> 
    <span class="n">hll</span><span class="o">.</span><span class="n">plus</span><span class="o">(</span><span class="n">hll1</span><span class="o">,</span> <span class="n">hll2</span><span class="o">)</span> <span class="o">)</span>
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              28/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            
            <section><div class="highlight"><pre><span></span><span class="n">println</span><span class="o">(</span><span class="s">&quot;...&quot;</span><span class="o">+</span>
         <span class="n">uniqueRowCount</span><span class="o">.</span><span class="n">estimatedSize</span><span class="o">.</span><span class="n">toLong</span><span class="o">)</span>
</pre></div>

<p><br />
<br /></p>
<p>Output
<br />
<br /></p>
<pre><code>estimated unique rows in data frame: 10813
</code></pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              29/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            
            <section><p>If two rows are identical, they will produce the same hash code.</p>
<pre><code>row 1: [a,b,123]
row 2: [a,b,123]
row 1 hash code: 345508721
row 2 hash code: 345508721
</code></pre>
<p><br />
<br /></p>
<p>in <code>spark.lecture10a.IdenticalRows</code></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              30/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            
            <section><p>Estimate number of unique teams, taken from <code>TeamName</code> column</p>
<p>Hash and make sketch of each team name</p>
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">teamSketches</span><span class="k">:</span> <span class="kt">RDD</span><span class="o">[</span><span class="kt">HLL</span><span class="o">]</span> <span class="k">=</span> 
  <span class="n">df</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="o">(</span><span class="n">r</span><span class="k">:</span> <span class="kt">Row</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="n">hll</span><span class="o">(</span><span class="n">r</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="n">hashCode</span><span class="o">)</span> <span class="o">}</span>
<span class="c1">//        ^ TeamName column</span>
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              31/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            
            <section><p>Reduce sketches to single sketch </p>
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">uniqueTeams</span><span class="k">:</span> <span class="kt">HLL</span> <span class="o">=</span>
  <span class="n">teamSketches</span><span class="o">.</span><span class="n">reduce</span><span class="o">(</span> <span class="o">(</span><span class="n">hll1</span><span class="o">,</span> <span class="n">hll2</span><span class="o">)</span> <span class="k">=&gt;</span> 
    <span class="n">hll</span><span class="o">.</span><span class="n">plus</span><span class="o">(</span><span class="n">hll1</span><span class="o">,</span> <span class="n">hll2</span><span class="o">)</span> <span class="o">)</span>

<span class="n">println</span><span class="o">(</span><span class="s">&quot;...&quot;</span><span class="o">+</span>
        <span class="n">uniqueTeams</span><span class="o">.</span><span class="n">estimatedSize</span><span class="o">.</span><span class="n">toLong</span><span class="o">)</span>
</pre></div>

<p>Output</p>
<pre><code>estimate of number of unique teams: 358
</code></pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              32/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            <header><h1>Product monoid</h1></header>
            
            
            <section><p>Calculate max score <em>and</em> estimate games played by team, in one sweep through the data</p>
<p>Use <code>Max</code> and <code>HLL</code></p>
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">df</span><span class="k">:</span> <span class="kt">DataFrame</span> <span class="o">=</span> <span class="o">...</span>

<span class="k">val</span> <span class="n">hll</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">HyperLogLogMonoid</span><span class="o">(</span><span class="mi">12</span><span class="o">)</span>
</pre></div>

<p>key by team name</p>
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">keyedRDD</span><span class="k">:</span> <span class="kt">RDD</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Row</span><span class="o">)]</span> <span class="k">=</span> 
  <span class="n">df</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">keyBy</span> <span class="o">{</span> <span class="o">(</span><span class="n">r</span><span class="k">:</span> <span class="kt">Row</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">r</span><span class="o">.</span><span class="n">getString</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">}</span>
</pre></div>

<p><br /></p>
<p>in <code>spark.lecture10a.MaxScoreAndGamesPlayed</code></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              33/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            
            <section><p>Our <a href="http://twitter.github.io/algebird/#com.twitter.algebird.Product2Monoid">product monoid</a></p>
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">productMonoid</span><span class="k">:</span> <span class="kt">Monoid</span><span class="o">[(</span><span class="kt">Max</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span>, <span class="kt">HLL</span><span class="o">)]</span> <span class="k">=</span>
  <span class="k">new</span> <span class="nc">Product2Monoid</span><span class="o">(</span>
    <span class="o">(</span><span class="n">mi</span><span class="k">:</span> <span class="kt">Max</span><span class="o">[</span><span class="kt">Int</span><span class="o">],</span> <span class="n">h</span><span class="k">:</span> <span class="kt">HLL</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">mi</span><span class="o">,</span> <span class="n">h</span><span class="o">),</span>
    <span class="o">(</span><span class="n">t</span><span class="k">:</span> <span class="o">(</span><span class="kt">Max</span><span class="o">[</span><span class="kt">Int</span><span class="o">],</span><span class="nc">HLL</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="n">t</span><span class="o">))</span>
    <span class="o">(</span><span class="nc">Max</span><span class="o">.</span><span class="n">intMonoid</span><span class="o">,</span> <span class="n">hll</span><span class="o">)</span>
</pre></div>

<p><br />
<br />
<br />
in <code>spark.lecture10a.MaxScoreAndGamesPlayed</code></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              34/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            
            <section><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">scoresAndCounts</span><span class="k">:</span><span class="kt">RDD</span><span class="o">[(</span><span class="kt">String</span>,<span class="o">(</span><span class="kt">Max</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span>, <span class="kt">HLL</span><span class="o">))]</span><span class="k">=</span> 
  <span class="n">keyedRDD</span><span class="o">.</span><span class="n">map</span><span class="o">{</span> <span class="k">case</span> <span class="o">(</span><span class="n">teamName</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span><span class="n">row</span><span class="k">:</span> <span class="kt">Row</span><span class="o">)</span><span class="k">=&gt;</span>
    <span class="k">val</span> <span class="n">score</span> <span class="k">=</span> <span class="n">row</span><span class="o">.</span><span class="n">getInt</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">maxScore</span><span class="k">:</span> <span class="kt">Max</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Max</span><span class="o">(</span><span class="n">score</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">rowSketch</span><span class="k">:</span> <span class="kt">HLL</span> <span class="o">=</span> <span class="n">hll</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="n">hashCode</span><span class="o">())</span>
    <span class="o">(</span><span class="n">teamName</span><span class="o">,</span> <span class="o">(</span><span class="n">maxScore</span><span class="o">,</span> <span class="n">rowSketch</span><span class="o">))</span>
  <span class="o">}</span>
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              35/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            
            <section><p>Reduce the products <code>(Max[Int], HLL)</code> into a single product, per key</p>
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">scoreAndCount</span><span class="k">:</span><span class="kt">RDD</span><span class="o">[(</span><span class="kt">String</span>,<span class="o">(</span><span class="kt">Max</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span>,<span class="kt">HLL</span><span class="o">))]</span> <span class="k">=</span>
  <span class="n">scoresAndCounts</span><span class="o">.</span><span class="n">reduceByKey</span> <span class="o">{</span> 
    <span class="o">(</span><span class="n">tup1</span><span class="k">:</span><span class="o">(</span><span class="kt">Max</span><span class="o">[</span><span class="kt">Int</span><span class="o">],</span><span class="nc">HLL</span><span class="o">),</span> <span class="n">tup2</span><span class="k">:</span><span class="o">(</span><span class="kt">Max</span><span class="o">[</span><span class="kt">Int</span><span class="o">],</span><span class="nc">HLL</span><span class="o">))</span> <span class="k">=&gt;</span>
    <span class="n">productMonoid</span><span class="o">.</span><span class="n">plus</span><span class="o">(</span><span class="n">tup1</span><span class="o">,</span> <span class="n">tup2</span><span class="o">)</span>
  <span class="o">}</span>
</pre></div>
</section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              36/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide has_code">
          <div class="inner">
            
            
            <section><div class="highlight"><pre><span></span><span class="n">scoreAndCount</span><span class="o">.</span><span class="n">foreach</span> <span class="o">{</span> 
  <span class="k">case</span> <span class="o">(</span><span class="n">teamName</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">tup</span><span class="k">:</span> <span class="o">(</span><span class="kt">Max</span><span class="o">[</span><span class="kt">Int</span><span class="o">],</span> <span class="nc">HLL</span><span class="o">))</span> <span class="k">=&gt;</span> 
  <span class="n">println</span><span class="o">(</span><span class="s">s&quot;Team </span><span class="si">$teamName</span><span class="s">  ... </span><span class="si">${</span><span class="n">tup</span><span class="o">.</span><span class="n">_1</span><span class="si">}</span><span class="s"> ...</span>
<span class="s">            ... </span><span class="si">${</span><span class="n">tup</span><span class="o">.</span><span class="n">_2</span><span class="o">.</span><span class="n">estimatedSize</span><span class="o">.</span><span class="n">toLong</span><span class="si">}</span><span class="s">&quot;</span><span class="o">)}</span>
</pre></div>

<p>Output</p>
<pre><code>Team Tennessee Tech  max score Max(101) 
                     games played 28
Team Western Mich.  max score Max(94) 
                     games played 30
Team Campbell  max score Max(101) 
                games played 27
Team Savannah St.  max score Max(76) 
                    games played 29
...
</code></pre></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              37/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source: lecture10a.md -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            <header><h1>Sources</h1></header>
            
            
            <section><p><a href="https://github.com/twitter/algebird/wiki/Learning-Algebird-Monoids-with-REPL">Learning Algebird Monoids with REPL</a></p>
<p><a href="https://www.parleys.com/tutorial/algebird-algebra-efficient-big-data-processing">https://www.parleys.com/tutorial/algebird-algebra-efficient-big-data-processing</a></p>
<p><a href="https://building.coursera.org/blog/2014/10/23/counting-at-scale-with-scalding-and-algebird/">https://building.coursera.org/blog/2014/10/23/counting-at-scale-with-scalding-and-algebird/</a></p>
<p><a href="http://cdn.oreillystatic.com/en/assets/1/event/105/Algebra%20for%20Scalable%20Analytics%20Presentation.pdf">http://cdn.oreillystatic.com/en/assets/1/event/105/Algebra%20for%20Scalable%20Analytics%20Presentation.pdf</a></p>
<p><a href="https://cs.uwaterloo.ca/~jimmylin/publications/Boykin_etal_VLDB2014_slides.pdf">https://cs.uwaterloo.ca/~jimmylin/publications/Boykin_etal_VLDB2014_slides.pdf</a></p>
<p><a href="https://www.quora.com/What-is-Twitters-interest-in-abstract-algebra-with-algebird">What is Twitter's interest in abstract algebra (with algebird)?</a></p>
<p><a href="https://github.com/twitter/algebird/wiki/HyperLogLog">HyperLogLog tutorial</a></p>
<p><a href="http://cem3394.github.io/scala-monoids/#slide1">http://cem3394.github.io/scala-monoids/#slide1</a></p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="source">
              Source: <a href="lecture10a.md">lecture10a.md</a>
            </aside>
            
            <aside class="page_number">
              38/38
            </aside>

          </footer>
        </div>
      </div>
      
      <!-- slide source:  -->
      <div class="slide-wrapper">
        <div class="slide">
          <div class="inner">
            
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>


          <footer>
            
            <aside class="page_number">
              /38
            </aside>

          </footer>
        </div>
      </div>
      
    </div>
  </div>
  
  <div id="toc" class="sidebar hidden">
    <h2>Table of Contents</h2>
    <table>
      <caption>Table of Contents</caption>
      
      <tr id="toc-row-1">
        <th><a href="#slide1">Lecture 10a: <a href="https://github.com/twitter/algebird">Algebird</a> in Spark</a></th>
        <td><a href="#slide1">1</a></td>
      </tr>
      
      
      <tr id="toc-row-2">
        <th><a href="#slide2"><a href="https://github.com/twitter/algebird">Algebird</a></a></th>
        <td><a href="#slide2">2</a></td>
      </tr>
      
      
      <tr id="toc-row-3">
        <th><a href="#slide3">Monoid review</a></th>
        <td><a href="#slide3">3</a></td>
      </tr>
      
      
      <tr id="toc-row-4">
        <th><a href="#slide4">-</a></th>
        <td><a href="#slide4">4</a></td>
      </tr>
      
      
      <tr id="toc-row-5">
        <th><a href="#slide5">Count-Min Sketch</a></th>
        <td><a href="#slide5">5</a></td>
      </tr>
      
      
      <tr id="toc-row-6">
        <th><a href="#slide6">-</a></th>
        <td><a href="#slide6">6</a></td>
      </tr>
      
      
      <tr id="toc-row-7">
        <th><a href="#slide7"><a href="http://twitter.github.io/algebird/#com.twitter.algebird.CMSMonoid">Count-min Sketch Monoid</a></a></th>
        <td><a href="#slide7">7</a></td>
      </tr>
      
      
      <tr id="toc-row-8">
        <th><a href="#slide8">-</a></th>
        <td><a href="#slide8">8</a></td>
      </tr>
      
      
      <tr id="toc-row-9">
        <th><a href="#slide9">-</a></th>
        <td><a href="#slide9">9</a></td>
      </tr>
      
      
      <tr id="toc-row-10">
        <th><a href="#slide10">Algebird example</a></th>
        <td><a href="#slide10">10</a></td>
      </tr>
      
      
      <tr id="toc-row-11">
        <th><a href="#slide11">-</a></th>
        <td><a href="#slide11">11</a></td>
      </tr>
      
      
      <tr id="toc-row-12">
        <th><a href="#slide12">-</a></th>
        <td><a href="#slide12">12</a></td>
      </tr>
      
      
      <tr id="toc-row-13">
        <th><a href="#slide13">-</a></th>
        <td><a href="#slide13">13</a></td>
      </tr>
      
      
      <tr id="toc-row-14">
        <th><a href="#slide14">-</a></th>
        <td><a href="#slide14">14</a></td>
      </tr>
      
      
      <tr id="toc-row-15">
        <th><a href="#slide15">-</a></th>
        <td><a href="#slide15">15</a></td>
      </tr>
      
      
      <tr id="toc-row-16">
        <th><a href="#slide16">-</a></th>
        <td><a href="#slide16">16</a></td>
      </tr>
      
      
      <tr id="toc-row-17">
        <th><a href="#slide17">Max Monoid in Spark</a></th>
        <td><a href="#slide17">17</a></td>
      </tr>
      
      
      <tr id="toc-row-18">
        <th><a href="#slide18">-</a></th>
        <td><a href="#slide18">18</a></td>
      </tr>
      
      
      <tr id="toc-row-19">
        <th><a href="#slide19">-</a></th>
        <td><a href="#slide19">19</a></td>
      </tr>
      
      
      <tr id="toc-row-20">
        <th><a href="#slide20"><a href="http://spark.apache.org/docs/latest/api/scala/index.html#org.apache.spark.rdd.PairRDDFunctions">Pair RDD</a></a></th>
        <td><a href="#slide20">20</a></td>
      </tr>
      
      
      <tr id="toc-row-21">
        <th><a href="#slide21">-</a></th>
        <td><a href="#slide21">21</a></td>
      </tr>
      
      
      <tr id="toc-row-22">
        <th><a href="#slide22">-</a></th>
        <td><a href="#slide22">22</a></td>
      </tr>
      
      
      <tr id="toc-row-23">
        <th><a href="#slide23">Count-min sketch in Spark</a></th>
        <td><a href="#slide23">23</a></td>
      </tr>
      
      
      <tr id="toc-row-24">
        <th><a href="#slide24">-</a></th>
        <td><a href="#slide24">24</a></td>
      </tr>
      
      
      <tr id="toc-row-25">
        <th><a href="#slide25">-</a></th>
        <td><a href="#slide25">25</a></td>
      </tr>
      
      
      <tr id="toc-row-26">
        <th><a href="#slide26">-</a></th>
        <td><a href="#slide26">26</a></td>
      </tr>
      
      
      <tr id="toc-row-27">
        <th><a href="#slide27">HyperLogLog in Spark</a></th>
        <td><a href="#slide27">27</a></td>
      </tr>
      
      
      <tr id="toc-row-28">
        <th><a href="#slide28">-</a></th>
        <td><a href="#slide28">28</a></td>
      </tr>
      
      
      <tr id="toc-row-29">
        <th><a href="#slide29">-</a></th>
        <td><a href="#slide29">29</a></td>
      </tr>
      
      
      <tr id="toc-row-30">
        <th><a href="#slide30">-</a></th>
        <td><a href="#slide30">30</a></td>
      </tr>
      
      
      <tr id="toc-row-31">
        <th><a href="#slide31">-</a></th>
        <td><a href="#slide31">31</a></td>
      </tr>
      
      
      <tr id="toc-row-32">
        <th><a href="#slide32">-</a></th>
        <td><a href="#slide32">32</a></td>
      </tr>
      
      
      <tr id="toc-row-33">
        <th><a href="#slide33">Product monoid</a></th>
        <td><a href="#slide33">33</a></td>
      </tr>
      
      
      <tr id="toc-row-34">
        <th><a href="#slide34">-</a></th>
        <td><a href="#slide34">34</a></td>
      </tr>
      
      
      <tr id="toc-row-35">
        <th><a href="#slide35">-</a></th>
        <td><a href="#slide35">35</a></td>
      </tr>
      
      
      <tr id="toc-row-36">
        <th><a href="#slide36">-</a></th>
        <td><a href="#slide36">36</a></td>
      </tr>
      
      
      <tr id="toc-row-37">
        <th><a href="#slide37">-</a></th>
        <td><a href="#slide37">37</a></td>
      </tr>
      
      
      <tr id="toc-row-38">
        <th><a href="#slide38">Sources</a></th>
        <td><a href="#slide38">38</a></td>
      </tr>
      
      
    </table>
  </div>
  
  <div id="help" class="sidebar hidden">
    <h2>Help</h2>
    <table>
      <caption>Help</caption>
      <tr>
        <th>Table of Contents</th>
        <td>t</td>
      </tr>
      <tr>
        <th>Exposé</th>
        <td>ESC</td>
      </tr>
      <tr>
        <th>Full screen slides</th>
        <td>e</td>
      </tr>
      <tr>
        <th>Presenter View</th>
        <td>p</td>
      </tr>
      <tr>
        <th>Source Files</th>
        <td>s</td>
      </tr>
      <tr>
        <th>Slide Numbers</th>
        <td>n</td>
      </tr>
      <tr>
        <th>Toggle screen blanking</th>
        <td>b</td>
      </tr>
      <tr>
        <th>Show/hide slide context</th>
        <td>c</td>
      </tr>
      <tr>
        <th>Notes</th>
        <td>2</td>
      </tr>
      <tr>
        <th>Help</th>
        <td>h</td>
      </tr>
    </table>
  </div>
  <script>main()</script>
</body>
</html>